<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Renovatie Direct • Visualisatietool</title>
  <meta name="description" content="Toon de nieuwe kozijnen, deuren en gevelbekleding direct op een foto van de woning." />
  <style>
    /* ====== Brand & thema (pas hier makkelijk kleuren aan) ====== */
    :root{
      --brand-navy: #111c2b;   /* donkerblauw/navy (kopteksten, knoppen) */
      --brand-green:#59b357;   /* Renovatie Direct groen */
      --brand-blue: #4fa3e3;   /* accentblauw uit icoon */
      --bg-cream:  #f9f6ea;    /* zachte crème achtergrond */
      --card:      #ffffff;
      --text:      #0e1320;
      --muted:     #647085;
      --line:      #e7e7ea;
      --radius-xl: 24px;
      --radius-lg: 18px;
      --radius-md: 14px;
      --shadow-1: 0 6px 22px rgba(17,28,43,.06);
      --shadow-2: 0 12px 28px rgba(17,28,43,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); background:var(--bg-cream);
    }

    /* ====== Header / brand bar ====== */
    .brandbar{
      display:flex; align-items:center; gap:14px;
      padding:16px 20px; background:var(--card);
      box-shadow: var(--shadow-1);
      position:sticky; top:0; z-index:20;
    }
    .brandbar img{ height:42px; width:auto; border-radius:10px }
    .brand-title{
      font-weight:800; letter-spacing:.2px; color:var(--brand-navy);
      line-height:1;
    }
    .brand-badge{
      margin-left:auto; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted); font-size:12px;
      background:#fff;
    }

    /* ====== Hero ====== */
    .hero{
      max-width:1100px; margin:32px auto 0; padding:0 16px 8px;
      display:grid; grid-template-columns: 1.1fr .9fr; gap:20px;
    }
    @media (max-width: 980px){ .hero{ grid-template-columns: 1fr; } }

    .tile{
      background:var(--card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2);
      padding:22px;
    }
    .tile h1{
      margin:6px 0 10px; font-size:28px; line-height:1.2; color:var(--brand-navy);
    }
    .lede{ color:var(--muted); margin:0 0 12px; }

    /* ====== Upload/controls ====== */
    .form{
      display:grid; gap:14px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:999px; background:#eef6ff; color:#114a7b;
      font-weight:600; font-size:13px;
    }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 720px){ .row{ grid-template-columns: 1fr; } }

    label{ font-weight:700; font-size:14px; margin-bottom:6px; display:block; }
    input[type="file"], select{
      width:100%; border: 1px solid var(--line); border-radius: var(--radius-md);
      background:#fff; padding:14px; font-size:15px;
      box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
    }
    .hint{ color:var(--muted); font-size:13px; }

    .actions{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn{
      appearance:none; border:0; cursor:pointer; font-weight:800; letter-spacing:.2px;
      padding:14px 18px; border-radius:18px; box-shadow: 0 6px 16px rgba(17,28,43,.12);
      background:linear-gradient(135deg, var(--brand-green), #3aa14b); color:#fff;
      transition:.2s transform ease, .2s box-shadow ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 10px 22px rgba(17,28,43,.18); }
    .btn.secondary{
      background:#fff; color:var(--brand-navy);
      border:1px solid var(--line);
      box-shadow: 0 6px 16px rgba(17,28,43,.06);
    }
    .status{ min-height:22px; }

    /* ====== Preview ====== */
    .preview{
      display:grid; gap:12px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 720px){ .preview{ grid-template-columns: 1fr; } }
    .shot{
      background:#f5f7fa; border:1px dashed var(--line);
      border-radius: var(--radius-lg); padding:10px; text-align:center;
    }
    .shot h4{ margin:4px 0 8px; font-size:13px; color:var(--muted); font-weight:700; letter-spacing:.2px; }
    .shot img{ display:block; max-width:100%; height:auto; border-radius:12px; }

    /* ====== Footer ====== */
    .foot{
      max-width:1100px; margin:18px auto 28px; padding:0 16px;
      color:var(--muted); font-size:12px; text-align:center;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="brandbar">
    <img src="/logo.png" alt="Renovatie Direct logo" style="height:42px; width:auto; border-radius:10px;" />
    <div>
      <div class="brand-title">Renovatie Direct</div>
      <div style="font-size:12px; color:var(--muted)">Visualisatietool</div>
    </div>
    <div class="brand-badge">Beta v1 • snél & overzichtelijk</div>
  </div>

  <!-- Hero: links controls, rechts preview -->
  <section class="hero">
    <div class="tile">
      <span class="pill">⚡ Snel & eenvoudig</span>
      <h1>Toon direct hoe het <em>straks</em> wordt</h1>
      <p class="lede">Upload een foto van de gevel, kies de kozijnkleur en genereer een realistische na-foto. Deuren en eventuele gevelbekleding worden automatisch meegenomen.</p>

      <div class="form">
        <div>
          <label for="file">Foto uploaden</label>
          <input id="file" type="file" accept="image/*">
          <div id="resizeInfo" class="hint"></div>
        </div>

        <div class="row">
          <div>
            <label for="kleurKozijn">Kozijnkleur</label>
            <select id="kleurKozijn">
              <option data-hex="#383E42">Antraciet (RAL 7016) • verdiept profiel</option>
              <option data-hex="#F5F6F7">Wit (RAL 9016) • verdiept profiel</option>
              <option data-hex="#E7DCC8">Crème (RAL 9001) • verdiept profiel</option>
              <option data-hex="#273C2C">Donkergroen (RAL 6009) • verdiept profiel</option>
              <option data-hex="#6B4E3D">Bruin (houtlook) • verdiept profiel</option>
              <option data-hex="#0A0A0A">Zwart (RAL 9005) • verdiept profiel</option>
            </select>
          </div>
          <div>
            <label for="afwerking">Afwerking</label>
            <select id="afwerking">
              <option>Mat</option>
              <option>Zijdeglans</option>
              <option>Structuur</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button id="go" class="btn">Genereer na-foto</button>
          <button id="reset" class="btn secondary" type="button">Reset</button>
          <span id="status" class="hint status"></span>
        </div>
        <details>
          <summary class="hint">Geavanceerd</summary>
          <div class="hint">De tool schaalt je foto klein voor een snelle upload en vraagt OpenAI om een realistische 1024p output. We veranderen alleen kozijnen, deuren en eventuele gevelbekleding; rest blijft identiek.</div>
        </details>
        <pre id="debug" class="hint" style="white-space:pre-wrap;"></pre>
      </div>
    </div>

    <div class="tile">
      <div class="preview">
        <div class="shot">
          <h4>VOOR</h4>
          <img id="voorImg" alt="Voorbeeld voor">
        </div>
        <div class="shot">
          <h4>NA (AI)</h4>
          <img id="naImg" alt="Voorbeeld na">
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
        <a id="download" style="display:none" download="na-foto.png" class="btn">Download</a>
        <span id="dlhint" class="hint"></span>
      </div>
    </div>
  </section>

  <footer class="foot">© Renovatie Direct • Visualisatietool • </footer>

  <script>
    // ====== UI helpers ======
    const $ = (id)=>document.getElementById(id);
    const fileInput = $("file");
    const voorEl = $("voorImg");
    const naEl = $("naImg");
    const statusEl = $("status");
    const debugEl = $("debug");
    const downloadEl = $("download");
    const dlhintEl = $("dlhint");
    const resizeInfo = $("resizeInfo");
    const kleurKozijn = $("kleurKozijn");
    const afwerking = $("afwerking");
    const goBtn = $("go");
    const resetBtn = $("reset");

    let preparedBlob = null;

    function selectedHex(sel){
      const o = sel.options[sel.selectedIndex];
      return o ? (o.getAttribute("data-hex")||"") : "";
    }

    // schaal client-side naar 512 voor upload-snelheid
    async function scaleTo512(file){
      const url = URL.createObjectURL(file);
      const img = new Image(); img.src = url; await img.decode();
      const canvas = document.createElement("canvas"); canvas.width=512; canvas.height=512;
      const ctx = canvas.getContext("2d");
      const scale = Math.max(512/img.naturalWidth, 512/img.naturalHeight);
      const dw = Math.round(img.naturalWidth*scale), dh = Math.round(img.naturalHeight*scale);
      const dx = Math.round((512 - dw)/2), dy = Math.round((512 - dh)/2);
      ctx.fillStyle = "#fff"; ctx.fillRect(0,0,512,512); // neutrale achtergrond
      ctx.drawImage(img, 0,0, img.naturalWidth, img.naturalHeight, dx, dy, dw, dh);
      const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.7));
      const outUrl = URL.createObjectURL(blob);
      URL.revokeObjectURL(url);
      return { blob, url: outUrl };
    }

    function blobToDataURL(blob){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    // ====== KORTSTE PROMPT ======
    function makePrompt(){
      const hex = selectedHex(kleurKozijn);
      const text = kleurKozijn.value;
      const finish = afwerking.value.toLowerCase();
      return [
        `Replace only window frames and doors with ${text}${hex?` (${hex})`:''}, ${finish}, deep uPVC style.`,
        'Match façade cladding if present.',
        'Do not change walls/brickwork, roof, ground, people, vehicles, sky, or background.',
        'Keep lighting, geometry, and perspective identical.'
      ].join(' ');
    }

    async function callAPI({blob, prompt}){
      const fd = new FormData();
      fd.append("prompt", prompt);
      fd.append("size", "auto"); // OpenAI kiest geldige output (meestal 1024)
      const dataUrl = await blobToDataURL(blob);
      fd.append("base", dataUrl);

      const res = await fetch("/api/generate", { method:"POST", body: fd });
      const ct = res.headers.get("content-type")||"";
      let payload;
      if (ct.includes("application/json")) payload = await res.json();
      else { const text = await res.text(); throw new Error("Server gaf geen JSON terug: " + text.slice(0,160)); }
      if (!res.ok) throw new Error(payload.error || "Onbekende fout");
      return payload.dataUrl;
    }

    // ====== Events ======
    fileInput.addEventListener("change", async ()=>{
      naEl.src = ""; downloadEl.style.display="none"; statusEl.textContent="";
      const f = fileInput.files[0]; if(!f){ voorEl.src=""; return; }
      statusEl.textContent = "Foto schalen…";
      try{
        const out = await scaleTo512(f);
        preparedBlob = out.blob; voorEl.src = out.url;
        resizeInfo.textContent = "Formaat: 512×512 JPEG (klein & snel) • output wordt automatisch 1024p";
        statusEl.textContent = "Klaar om te genereren.";
      }catch(e){
        statusEl.textContent = "❌ Fout bij schalen van afbeelding."; debugEl.textContent=String(e);
      }
    });

    resetBtn.addEventListener("click", ()=>{
      fileInput.value=""; voorEl.src=""; naEl.src=""; preparedBlob=null;
      statusEl.textContent=""; debugEl.textContent=""; resizeInfo.textContent=""; downloadEl.style.display="none"; dlhintEl.textContent="";
    });

    $("go").addEventListener("click", async ()=>{
      try{
        if(!preparedBlob){ statusEl.textContent="📷 Kies eerst een foto."; return; }
        statusEl.textContent = "Bezig…"; debugEl.textContent="";
        const url = await callAPI({ blob: preparedBlob, prompt: makePrompt() });
        naEl.src = url;
        downloadEl.href = url; downloadEl.style.display="inline-flex";
        dlhintEl.textContent = "Tip: laat de klant inzoomen op details.";
        statusEl.textContent = "✅ Klaar!";
      }catch(err){
        statusEl.textContent = "❌ Fout: " + (err?.message || "Onbekend");
        debugEl.textContent = String(err?.stack || err);
      }
    });
  </script>
</body>
</html>
